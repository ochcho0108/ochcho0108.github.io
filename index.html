<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학습 프로젝트 등급 조회</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-2xl text-center">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">학습 프로젝트 등급 조회</h1>

        <!-- 검색 입력란 -->
        <div class="mb-6">
            <input type="text" id="nameInput" placeholder="이름을 입력하세요 (예: 김민경)"
                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition-colors">
        </div>

        <!-- 결과 표시 섹션 -->
        <div id="loading" class="text-center text-gray-500 hidden">
            <p>데이터를 불러오는 중입니다...</p>
        </div>
        
        <div id="resultContainer" class="hidden">
            <div id="studentInfo" class="text-left mb-6"></div>
            <div id="gradeResult" class="p-6 rounded-lg font-bold text-white transition-all duration-300"></div>
            <div id="additionalMessage" class="mt-4 text-gray-700 text-left"></div>
        </div>
        
        <div id="notFoundMessage" class="hidden text-red-500 font-bold mt-4">
            <p>해당하는 학생을 찾을 수 없습니다. 이름을 다시 확인해주세요.</p>
        </div>
    </div>

    <script>
        // 이 부분에 제공해 주신 구글 스프레드시트 CSV URL을 붙여넣었습니다.
        const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQfsOjg2wKByAA6qkEXo78Jsj2HtJ6gSS4nJU8ZAwYT_XP4FYJ_Y35ZP3PYAL_mDl8Ah9QV-hQwbWMl/pub?output=csv';

        document.getElementById('nameInput').addEventListener('input', debounce(handleSearch, 500));

        async function handleSearch(event) {
            const name = event.target.value.trim();
            if (name.length < 2) {
                // 이름이 2자 미만일 경우 검색하지 않음
                document.getElementById('resultContainer').classList.add('hidden');
                document.getElementById('notFoundMessage').classList.add('hidden');
                return;
            }

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('resultContainer').classList.add('hidden');
            document.getElementById('notFoundMessage').classList.add('hidden');

            try {
                const response = await fetch(SPREADSHEET_URL);
                if (!response.ok) {
                    throw new Error('네트워크 응답이 올바르지 않습니다.');
                }
                const csvText = await response.text();
                const data = parseCSV(csvText);
                
                const studentData = data.filter(row => row['이름'] === name);
                
                if (studentData.length > 0) {
                    displayResults(studentData, name);
                } else {
                    document.getElementById('notFoundMessage').classList.remove('hidden');
                }
            } catch (error) {
                console.error("데이터를 가져오는 중 오류 발생:", error);
                document.getElementById('notFoundMessage').innerText = '데이터를 불러오는 데 실패했습니다.';
                document.getElementById('notFoundMessage').classList.remove('hidden');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }
        
        function parseCSV(text) {
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(value => value.trim().replace(/"/g, ''));
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    data.push(row);
                }
            }
            return data;
        }

        function calculateFinalScore(studentActivities) {
            let totalAuthScore = 0;
            let totalCheckScore = 0;
            
            // 활동별 점수 합산
            studentActivities.forEach(activity => {
                const difficulty = activity['난이도'];
                const basicScore = parseInt(activity['기본 점수']);
                const checkStatus = activity['체크 여부'];

                // 난이도별 점수 계산
                if (difficulty === '상') {
                    totalAuthScore += basicScore * 1.5;
                } else if (difficulty === '하') {
                    totalAuthScore += basicScore * 1.0;
                }

                // 공지 체크 점수 계산
                if (checkStatus === 'O') {
                    totalCheckScore += 5;
                }
            });

            // 총점 상한선 적용
            totalAuthScore = Math.min(totalAuthScore, 70);
            totalCheckScore = Math.min(totalCheckScore, 30);
            
            return Math.floor(totalAuthScore + totalCheckScore);
        }

        function displayResults(studentData, name) {
            const finalScore = calculateFinalScore(studentData);
            let grade = '';
            let message = '';
            let gradeColor = '';
            
            if (finalScore >= 90) {
                grade = 'A등급';
                message = '훌륭합니다! 학습 주도 프로젝트의 모든 목표를 완벽하게 달성했네요. 지금처럼 꾸준히 노력하면 더 큰 성장을 이룰 수 있을 거예요.';
                gradeColor = 'bg-blue-500';
            } else if (finalScore >= 70) {
                grade = 'B등급';
                message = '아주 잘하고 있어요! 프로젝트에 적극적으로 참여하고 좋은 성과를 냈습니다. 다음 목표를 설정하고 도전한다면 A등급도 문제없을 거예요.';
                gradeColor = 'bg-green-500';
            } else if (finalScore >= 50) {
                grade = 'C등급';
                message = '괜찮은 성과입니다. 참여도는 좋았지만, 난이도 상 프로젝트에 더 도전하거나 공지 체크를 놓친 부분이 있는지 확인해 보세요.';
                gradeColor = 'bg-yellow-500';
            } else if (finalScore >= 30) {
                grade = 'D등급';
                message = '노력이 필요해 보입니다. 난이도 상/하 프로젝트 인증 횟수를 늘리고, 공지 체크를 잊지 않도록 노력한다면 점수가 오를 거예요.';
                gradeColor = 'bg-orange-500';
            } else {
                grade = 'E등급';
                message = '학습 보완이 필요한 단계입니다. 전문가와 함께 학습 계획을 다시 세워보는 것을 추천합니다. 작은 목표부터 하나씩 달성해 나가는 것이 중요합니다.';
                gradeColor = 'bg-red-500';
            }

            const resultContainer = document.getElementById('resultContainer');
            const studentInfo = document.getElementById('studentInfo');
            const gradeResult = document.getElementById('gradeResult');
            const additionalMessage = document.getElementById('additionalMessage');

            // 학생 활동 내역을 요약하여 표시
            const totalHard = studentData.filter(d => d['난이도'] === '상').length;
            const totalEasy = studentData.filter(d => d['난이도'] === '하').length;
            const totalCheck = studentData.filter(d => d['체크 여부'] === 'O').length;
            
            studentInfo.innerHTML = `
                <p><span class="font-bold">이름:</span> ${name}</p>
                <p><span class="font-bold">총 인증 횟수:</span> 상 ${totalHard}회, 하 ${totalEasy}회</p>
                <p><span class="font-bold">공지 체크 횟수:</span> ${totalCheck}회</p>
            `;
            
            // 등급 결과 표시
            gradeResult.className = `p-6 rounded-lg font-bold text-white transition-all duration-300 ${gradeColor}`;
            gradeResult.innerHTML = `<p class="text-2xl">${name} 학생의 최종 점수는 ${finalScore}점이며, 등급은 <span class="text-4xl">${grade}</span> 입니다.</p>`;
            
            // 추가 메시지 표시
            additionalMessage.innerHTML = `<p class="font-bold">신용평가 시스템의 중요성 및 학습 보완법:</p><p>${message}</p>`;

            resultContainer.classList.remove('hidden');
        }

        // 입력 시마다 함수가 실행되는 것을 방지하기 위한 디바운스 함수
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }
    </script>
</body>
</html>
